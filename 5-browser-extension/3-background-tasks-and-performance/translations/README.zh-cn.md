# æµè§ˆå™¨æ‰©å±•æ’ä»¶ Part 1ï¼šå­¦ä¹ èƒŒæ™¯å·¥ä½œä¸æ•ˆèƒ½

## è¯¾å‰æµ‹éªŒ

[è¯¾å‰æµ‹éªŒ](https://ashy-river-0debb7803.1.azurestaticapps.net/quiz/27?loc=zh_tw)

### å¤§çº²

åœ¨å‰ä¸¤å ‚è¯¾ç¨‹ä¸­ï¼Œä½ å­¦ä¼šå¦‚ä½•å»ºç«‹è¡¨å•ã€åœ¨ç»“æœåŒºå—ä¸­æ˜¾ç¤º API å›å¤çš„èµ„æ–™ï¼Œè¿™æ˜¯ç½‘é¡µå¤„ç†ä¿¡æ¯çš„æ ‡å‡†æµç¨‹ã€‚ä¹ŸæŒæ¡äº†å¦‚ä½•å¼‚æ­¥åœ°æŠ“å–èµ„æ–™ï¼Œè¿™é¡¹æ‰©å±•æ’ä»¶å·²ç»æ¥è¿‘å®Œæˆäº†ã€‚

ç›®å‰åªå‰©ä¸‹ç®¡ç†èƒŒæ™¯å·¥ä½œï¼šåŒ…æ‹¬åˆ·æ–°æ’ä»¶çš„å›¾ç¤ºé¢œè‰²ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å­¦ä¹ æµè§ˆå™¨æ˜¯å¦‚ä½•å¤„ç†è¿™ç±»çš„å·¥ä½œï¼Œä¹Ÿè®©æˆ‘ä»¬åˆ†æç½‘é¡µçš„æ•°æ®å¤„ç†é€»è¾‘ä»¥åŠæµè§ˆå™¨ä¼šå¤šæœ‰æ•ˆåœ°å¤„ç†å…¶ä¸­çš„å†…å®¹ã€‚

## ç½‘é¡µå¤„ç†æ•ˆèƒ½çš„åŸºç¡€

> "ç½‘é¡µå¤„ç†æ•ˆèƒ½å…³ä¹ä¸¤ä»¶äº‹ï¼šç½‘é¡µå¤šå¿«åœ°è½½å…¥ï¼Œä¸ç¨‹åºå¤šå¿«åœ°æ‰§è¡Œã€‚" -- [Zack Grossbart](https://www.smashingmagazine.com/2012/06/javascript-profiling-chrome-developer-tools/)

å…³äºå¦‚ä½•è®©ä½ çš„ç½‘é¡µèƒ½å¿«é€Ÿåœ°è¿ä½œåœ¨å„ç±»ç»ˆç«¯è®¾å¤‡ã€å„ä¸ªä½¿ç”¨è€…ä»¥åŠå„ç§æƒ…å†µï¼Œæ˜¯ä¸€ä»¶éš¾ä»¥æƒ³åƒçš„åºå¤§ä¸»é¢˜ã€‚è¿™é‡Œæœ‰ä¸€äº›è¦ç‚¹ç¡®ä¿ä½ åœ¨å¼€å‘ç½‘é¡µæˆ–æ˜¯æ‰©å±•æ’ä»¶æ—¶ï¼Œé“­è®°åœ¨å¿ƒã€‚

ç¬¬ä¸€ä»¶äº‹ï¼Œä¸ºç¡®ä¿ç½‘é¡µæ”¶é›†å…³äºç½‘é¡µæ•ˆèƒ½çš„èµ„æ–™ï¼Œåœ¨æµè§ˆå™¨çš„å¼€å‘è€…å·¥å…·ä¸­å¯ä»¥å®ç°å®ƒã€‚åœ¨ Chromeå’ŒEdge ä¸­ï¼Œé€‰æ‹©ã€Œè®¾å®šåŠæ›´å¤šã€æŒ‰é’®(æµè§ˆå™¨ä¸Šä¸‰ä¸ªç‚¹çš„å›¾ç¤º)ï¼Œå¹¶é€‰æ‹©æ›´å¤šå·¥å…· > å¼€å‘äººå‘˜å·¥å…·å¹¶å¼€å¯ Performance åˆ†é¡µã€‚ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨é”®ç›˜å¿«æ·é”®ï¼ŒWindows ä¸Šçš„ `Ctrl` + `Shift` + `I` ä¸ Mac ä¸Šçš„ `Option` + `Command` + `I` æ¥å¼€å¯å¼€å‘äººå‘˜å·¥å…·ã€‚

Performance åˆ†é¡µåŒ…æ‹¬äº†æ•ˆèƒ½åˆ†æå·¥å…·ã€‚å¼€å¯ä¸€ä¸ªç½‘é¡µï¼Œä¾‹å¦‚ https://www.bupt.edu.cn ï¼Œç‚¹å‡» 'Record' æŒ‰é’®å¹¶é‡æ–°æ•´ç†ç½‘é¡µã€‚åœæ­¢å½•åˆ¶åä½ å°±èƒ½å–å¾—ç½‘é¡µçš„ 'script'ã€'render' ä¸ 'paint' çš„è¿‡ç¨‹ä¸èµ„è®¯ï¼š

![Edge æ€§èƒ½åˆ†æå·¥å…·](./images/profiler.png)

âœ… è®¿é—® [Microsoft æ–‡ä»¶](https://docs.microsoft.com/microsoft-edge/devtools-guide/performance/?WT.mc_id=academic-77807-sagibbon)è§‚çœ‹ Edge çš„ Performance åˆ†é¡µä¿¡æ¯

> æç¤ºï¼šè¦å–å¾—çœŸæ­£çš„ç½‘é¡µå¼€å¯æ—¶é—´ï¼Œè®°å¾—æ¸…é™¤ä½ çš„æµè§ˆå™¨ç¼“å­˜ã€‚

é€‰æ‹©ç½‘é¡µåœ¨è½½å…¥æ—¶æ—¶é—´åˆ—ä¸­å‡ºç°çš„å†…å®¹ã€‚

è§‚çœ‹å®ƒçš„æ€»è§ˆé¢æ¿å¹¶æˆªå›¾è®°å½•ç½‘é¡µæ•ˆèƒ½ã€‚

![Edge æ€§èƒ½åˆ†æå·¥å…·æˆªå›¾](./images/snapshot.png)

æ£€æŸ¥ Event Log é¢æ¿ï¼Œæ˜¯å¦æœ‰ç½‘é¡µäº‹ä»¶èŠ±è¶…è¿‡ 15 æ¯«ç§’ï¼š

![Edge event log](./images/log.png)

âœ… äº†è§£æ€§èƒ½åˆ†æå·¥å…·ï¼åœ¨è¿™ä¸ªç½‘é¡µä¸­ï¼Œå¼€å¯å¼€å‘è€…å·¥å…·ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•ç“¶é¢ˆã€‚ä»€ä¹ˆæ˜¯è½½å…¥æœ€ä¹…çš„ç»„ä»¶ï¼Ÿå“ªä¸ªåˆæ˜¯æœ€å¿«çš„ï¼Ÿ

## æ•ˆèƒ½åˆ†æ

æ€»ä½“è€Œè¨€ï¼Œæ¯ä¸€ä½ç½‘é¡µå¼€å‘è€…ä¸€å®šè¦æ³¨æ„ä¸€äº›ã€Œæœ‰é—®é¢˜çš„åœ°æ–¹ã€ï¼Œé¿å…åœ¨å‘å¸ƒä½œå“æ—¶æœ‰ä»¤äººæ„æƒ³ä¸åˆ°çš„æƒŠå–œã€‚

**èµ„äº§(Asset)å¤§å°**ï¼šè¿‡å»å‡ å¹´æ¥ï¼Œç½‘é¡µã€Œå˜é‡ã€äº†ï¼Œä¹Ÿå› æ­¤å˜æ…¢äº†ã€‚æœ‰äº›è´Ÿæ‹…æ¥è‡ªäºå›¾ç‰‡çš„ä½¿ç”¨ã€‚

âœ… æŸ¥è¯¢ [Internet Archive](https://httparchive.org/reports/page-weight)ï¼Œçœ‹çœ‹è¿‡å»çš„ç½‘é¡µè´Ÿè½½ç­‰ä¿¡æ¯ã€‚

ä¸€ä¸ªå¥½çš„ä¹ æƒ¯æ˜¯ç¡®ä¿ä½ çš„å›¾ç‰‡æœ‰åšä¼˜åŒ–ï¼Œå‘ˆç°åˆç†çš„æ¡£æ¡ˆå¤§å°åŠåˆ†è¾¨ç‡å½±åƒç»™ä½ çš„ä½¿ç”¨è€…ã€‚

**DOM æŸ¥æ‰¾å…ƒç´ (Traversal)**ï¼šæµè§ˆå™¨å¿…é¡»ä¾ç…§ä½ çš„ç¨‹åºå»ºç«‹ Document Object Modelï¼Œè¯·ç¡®ä¿ä½ çš„ tags æœ€å°åŒ–ï¼Œç½‘é¡µåªä½¿ç”¨å¿…é¡»çš„åŠŸèƒ½ä¸é£æ ¼ã€‚å¦å¤–ï¼Œè¿‡é‡çš„ç½‘é¡µ CSS ä¹Ÿå¯ä»¥è¢«ä¼˜åŒ–ï¼Œä¸¾ä¾‹æ¥è¯´ï¼Œé€ å‹æ ·æ¿åªç”¨åœ¨å•é¡µä¸Šï¼Œè€Œéå…¨åŸŸä¸Šã€‚

**JavaScript**ï¼šæ¯ä¸€ä½ JavaScript å¼€å‘è€…éƒ½éœ€è¦ä¼šè§‚å¯Ÿ 'render-blocking' è„šæœ¬ï¼Œå®ƒä¼šåœ¨ DOM æŸ¥æ‰¾ä¸æµè§ˆå™¨å‘ˆç°å‰è¢«è½½å…¥å¥½ã€‚è¯·è€ƒè™‘ä½¿ç”¨ `defer` åœ¨ä½ çš„ç¨‹åºä¸­ï¼Œæˆ‘ä»¬çš„ç›†æ ½ç›’ä¸“æ¡ˆå°±æœ‰ç»ƒä¹ è¿™ä¸ªç”¨æ³•ã€‚

âœ… åœ¨[ç½‘é¡µæµ‹é€Ÿç½‘](https://www.webpagetest.org/)ä¸Šæµ‹è¯•ä¸€äº›ç½‘é¡µï¼Œå­¦ä¹ ç¡®è®¤ç½‘é¡µæ•ˆèƒ½çš„åŸºæœ¬æ£€æŸ¥ã€‚

ç°åœ¨ä½ äº†è§£æµè§ˆå™¨å¦‚ä½•å‘ˆç°ä½ æ‰€æä¾›çš„ä¿¡æ¯èµ„äº§ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹æˆ‘ä»¬çš„æ‰©å±•æ’ä»¶æœ€åéœ€è¦è¡¥é½çš„é¡¹ç›®ï¼š

### å»ºç«‹å‡½æ•°è®¡ç®—å¯¹åº”çš„é¢œè‰²

ç¼–è¾‘ `/src/index.js`ï¼Œæ–°å¢å‡½æ•° `calculateColor()` åœ¨ä¸€ç³»åˆ—ä¸ºäº† DOM å­˜å–çš„ `const` å˜æ•°ä¹‹åï¼š

```JavaScript
function calculateColor(value) {
	let co2Scale = [0, 150, 600, 750, 800];
	let colors = ['#2AA364', '#F5EB4D', '#9E4229', '#381D02', '#381D02'];

	let closestNum = co2Scale.sort((a, b) => {
		return Math.abs(a - value) - Math.abs(b - value);
	})[0];
	console.log(value + ' is closest to ' + closestNum);
	let num = (element) => element > closestNum;
	let scaleIndex = co2Scale.findIndex(num);

	let closestColor = colors[scaleIndex];
	console.log(scaleIndex, closestColor);

	chrome.runtime.sendMessage({ action: 'updateIcon', value: { color: closestColor } });
}
```

å‘ç”Ÿäº†ä»€ä¹ˆäº‹ï¼Ÿä½ ä¼ é€’äº† API è¿”å›çš„äºŒæ°§åŒ–ç¢³æµ“åº¦æ•°å€¼ï¼Œè®¡ç®—å‡ºå®ƒæœ€é€‚åˆå¯¹åº”çš„é¢œè‰²çŸ©é˜µç´¢å¼•ä½ç½®ã€‚ä¹‹åï¼Œä½ å°†è¿™ä¸ªé¢œè‰²æ•°å€¼ä¼ ç»™äº† chrome runtimeã€‚

chrome.runtime æœ‰[ä¸€ä¸ª API](https://developer.chrome.com/extensions/runtime)å¤„ç†æ‰€æœ‰çš„èƒŒæ™¯å·¥ä½œï¼Œä½ çš„æ‰©å±•æ’ä»¶å€ŸåŠ©äº†æ­¤åŠŸèƒ½ï¼š

> "åœ¨åº”ç”¨ç¨‹å¼ä¸­ï¼Œä½¿ç”¨ chrome.runtime API æ¥æ¥æ”¶èƒŒæ™¯é¡µé¢ï¼Œå›ä¼ å…³äº manifest çš„ä¿¡æ¯ï¼Œç›‘å¬å¹¶å›åº”äº‹ä»¶ã€‚ä½ ä¹Ÿå¯ä»¥åˆ©ç”¨æ­¤ API è½¬æ¢ URL çš„ç›¸å¯¹è·¯å¾„æˆç»å¯¹è·¯å¾„ã€‚"

âœ… å¦‚æœä½ æ­£æ‰“ç®—å¼€å‘è¿™ä¸ªæ’ä»¶ç»™ Edge æµè§ˆå™¨ä¸Šä½¿ç”¨ï¼Œä½ å¯èƒ½ä¼šæƒŠè®¶åœ°å‘ç°ä½ ä½¿ç”¨çš„æ˜¯ chrome APIã€‚æ–°çš„ Edge æµè§ˆå™¨æ‰§è¡Œåœ¨ Chromium browser å¼•æ“ä¸Šï¼Œæ‰€ä»¥ä½ ä¹Ÿèƒ½ä½¿ç”¨è¿™äº›å·¥å…·ã€‚

> æ³¨æ„ï¼Œå¦‚æœä½ æƒ³è¦åˆ†ææµè§ˆå™¨æ‰©å……åŠŸèƒ½ï¼Œè¯·åœ¨æ‰©å……æ’ä»¶ä¸Šæ‰§è¡Œå¼€å‘è€…å·¥å…·ï¼Œå®ƒä¸æµè§ˆå™¨ä¸»è§†çª—æ˜¯ä¸åŒçš„ä¸ªä½“ã€‚

### è®¾å®šå›¾ç¤ºé¢„è®¾é¢œè‰²

ç°åœ¨ï¼Œåœ¨å‡½å¼ `init()` ä¸­ï¼Œè°ƒç”¨ chrome `updateIcon` è®¾å®šå›¾ç¤ºé¢œè‰²ä¸ºé€šç”¨ç»¿ï¼š

```JavaScript
chrome.runtime.sendMessage({
	action: 'updateIcon',
		value: {
			color: 'green',
		},
});
```
### è°ƒç”¨å‡½æ•°ã€æ‰§è¡Œè¯·æ±‚

æ¥ä¸‹æ¥ï¼Œåœ¨ C02Signal API å›ä¼ çš„ promise ç‰©ä»¶ä¸‹æ–¹è°ƒç”¨å‡½æ•°ï¼š

```JavaScript
//let CO2...
calculateColor(CO2);
```
æœ€åï¼Œåœ¨ä»£ç  `/dist/background.js` ä¸­ï¼Œæ–°å¢äº‹ä»¶ç›‘å¬è€…ç»™è¿™äº›èƒŒæ™¯è¡Œä¸ºçš„è°ƒç”¨ï¼š

```JavaScript
chrome.runtime.onMessage.addListener(function (msg, sender, sendResponse) {
	if (msg.action === 'updateIcon') {
		chrome.browserAction.setIcon({ imageData: drawIcon(msg.value) });
	}
});
//å‚è€ƒ energy lollipop extensionï¼Œå¾ˆå¥½çš„ç¨‹å¼ï¼
function drawIcon(value) {
	let canvas = document.createElement('canvas');
	let context = canvas.getContext('2d');

	context.beginPath();
	context.fillStyle = value.color;
	context.arc(100, 100, 50, 0, 2 * Math.PI);
	context.fill();

	return context.getImageData(50, 50, 100, 100);
}
```
åœ¨æ­¤ç¨‹åºä¸­ï¼Œä½ å»ºç«‹äº†äº‹ä»¶ç›‘å¬è€…ç»™æ‰€æœ‰çš„èƒŒæ™¯ç®¡ç†ç»„ä»¶ã€‚ä¾‹å¦‚ï¼Œ'updateIcon' è¢«è°ƒç”¨ï¼Œåˆ™æ¥ä¸‹æ¥çš„ç¨‹åºä¼šè¢«æ‰§è¡Œï¼Œåˆ©ç”¨ Canvas API ç»˜åˆ¶å‡ºå¯¹åº”é¢œè‰²çš„å›¾ç¤ºã€‚

âœ… ä½ ä¼šå­¦ä¹ æ›´å¤šå…³äº Canvas API åœ¨å¾€åçš„[å¤ªç©ºæ¸¸æˆè¯¾ç¨‹](../../../6-space-game/2-drawing-to-canvas/translations/README.zh-tw.md)ã€‚

ç°åœ¨ï¼Œé‡æ–°ç¼–è¯‘ä½ çš„æ‰©å……åŠŸèƒ½(`npm run build`)ï¼Œåˆ·æ–°å¹¶è¿è¡Œä½ çš„å¥—ä»¶ï¼Œè§‚å¯Ÿå›¾ç¤ºçš„é¢œè‰²å˜åŒ–ã€‚

æ­å–œä½ ï¼Œä½ å·²ç»å»ºç«‹äº†ä¸€æ¬¾å®ç”¨çš„æµè§ˆå™¨æ‰©å±•æ’ä»¶ï¼Œå¹¶å­¦åˆ°æ›´å¤šæµè§ˆå™¨çš„è¿ä½œæ–¹å¼ä¸ç›‘æµ‹å®ƒçš„æ•ˆèƒ½åˆ†æã€‚

---

<!-- ## ğŸš€ æŒ‘æˆ˜

è°ƒæŸ¥ä¸€äº›æ‚ ä¹…çš„å¼€æºç½‘ç«™ï¼Œå¹¶æ ¹æ®å®ƒä»¬çš„ GitHub å†å²ï¼Œä½ èƒ½åˆ†è¾¨å®ƒä»¬è¿‡å»å‡ å¹´ä»¥æ¥æ•ˆèƒ½ä¸Šçš„è°ƒæ•´å—ï¼Ÿä»€ä¹ˆå®ƒä»¬æ˜¯å…±åŒçš„ç—›ç‚¹ï¼Ÿ -->

## è¯¾åæµ‹éªŒ

[è¯¾åæµ‹éªŒ](https://ashy-river-0debb7803.1.azurestaticapps.net/quiz/28?loc=zh_tw)

## å¤ä¹ ä¸è‡ªå­¦

è¯·è€ƒè™‘æ³¨å†Œ[performance newsletter](https://perf.email/)

è°ƒæŸ¥æµè§ˆå™¨æµ‹é‡ç½‘é¡µæ•ˆèƒ½çš„æ–¹æ³•ï¼ŒæŸ¥çœ‹å¼€å‘è€…å·¥å…·å†…çš„ Performance åˆ†é¡µã€‚ä½ èƒ½æ‰¾åˆ°ä»€ä¹ˆå·¨å¤§çš„å·®åˆ«å—ï¼Ÿ

## ä½œä¸š

[å®Œæˆä¸€æ¬¾æµè§ˆå™¨æ’ä»¶](./assignment.zh-cn.md)

